<?xml version="1.0" encoding="UTF-8"?>

<precice-configuration>
  
  <!-- Moved dimensions="3" to each mesh and applied naming conventions -->
  <mesh name="SU2-CFD-Mesh" dimensions="3">
    <use-data name="Force"/>
    <use-data name="Displacement-Delta"/>
  </mesh>

  <mesh name="Calculix-Mesh" dimensions="3">
    <use-data name="Displacement-Delta"/>
    <use-data name="Force"/>
  </mesh>

  <!-- we rename SOLIDZ_Mesh to Calculix-Z-Mesh, following the new convention. -->
  <mesh name="Calculix-Z-Mesh" dimensions="3">
    <!-- In some setups, you might use the same data names, or others. Adjust if needed. -->
    <use-data name="Displacement-Delta"/>
    <use-data name="Force"/>
  </mesh>

  <!-- Participant "SU2_CFD" renamed to "SU2-CFD" -->
  <participant name="SU2-CFD">
    <!-- Provide or receive the needed meshes -->
    <receive-mesh name="Calculix-Mesh" from="Calculix"/>
    <provide-mesh name="SU2-CFD-Mesh"/>
    
    <!-- Data usage with updated names -->
    <write-data name="Force" mesh="SU2-CFD-Mesh"/>
    <read-data  name="Displacement-Delta" mesh="SU2-CFD-Mesh"/>
    
    <!-- Remove timing attributes -->
    <mapping:nearest-neighbor
        direction="write"
        from="SU2-CFD-Mesh" to="Calculix-Mesh"
        constraint="conservative" />
    <mapping:nearest-neighbor
        direction="read"
        from="Calculix-Mesh" to="SU2-CFD-Mesh"
        constraint="consistent" />
  </participant>

  <participant name="Calculix">
    <provide-mesh name="Calculix-Mesh"/>
    <!-- If needed, it could also provide the "Calculix-Z-Mesh" or receive it, 
         depending on the actual use-case. Here, we keep it minimal. -->
    <write-data name="Displacement-Delta" mesh="Calculix-Mesh"/>
    <read-data  name="Force" mesh="Calculix-Mesh"/>
  </participant>

  <!-- Updated "from" and "to" → "acceptor" and "connector" -->
  <m2n:sockets acceptor="SU2-CFD" connector="Calculix" exchange-directory="../"/>
  
  <coupling-scheme:parallel-implicit>
    <participants first="SU2-CFD" second="Calculix"/>
    
    <!-- Renamed attributes -->
    <max-time-windows value="20"/>
    <time-window-size value="1e-3"/>
    
    <!-- Exchanges with updated data and mesh names -->
    <exchange data="Force"             mesh="Calculix-Mesh" from="SU2-CFD"  to="Calculix"/>
    <exchange data="Displacement-Delta" mesh="Calculix-Mesh" from="Calculix" to="SU2-CFD"/>
    
    <max-iterations value="50"/>
    
    <relative-convergence-measure limit="1e-4" data="Displacement-Delta" mesh="Calculix-Mesh"/>
    <relative-convergence-measure limit="1e-4" data="Force"             mesh="Calculix-Mesh"/>
    
    <!-- Removed <extrapolation-order> because v3 no longer supports it -->

    <!-- Renamed <post-processing:IQN-ILS> to <acceleration:IQN-ILS> 
         and adjusted data/mesh names to new naming. 
         Example usage with the special "Calculix-Z-Mesh" -->
    <acceleration:IQN-ILS>
      <data name="Displacement-Delta" mesh="Calculix-Z-Mesh"/>
      <data name="Force"             mesh="Calculix-Z-Mesh"/>
      <preconditioner type="residual-sum"/>
      <filter type="QR1" limit="1e-6"/>
      <initial-relaxation value="0.1"/>
      <max-used-iterations value="50"/>
      <!-- Renamed timesteps-reused → time-windows-reused -->
      <time-windows-reused value="10"/>
    </acceleration:IQN-ILS>

  </coupling-scheme:parallel-implicit>

</precice-configuration>
