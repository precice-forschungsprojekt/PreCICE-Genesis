<?xml version="1.0" encoding="UTF-8"?>
<precice-configuration>
  <!-- Removed <solver-interface> wrapper and moved its children up under <precice-configuration>. -->

  <!-- Data vector definitions remain unchanged. -->
  <data:vector name="Forces1"/>
  <data:vector name="Forces2"/>
  <data:vector name="Forces3"/>
  <data:vector name="Forces4"/>
  <data:vector name="Displacements1"/>
  <data:vector name="Displacements2"/>
  <data:vector name="Displacements3"/>
  <data:vector name="Displacements4"/>

  <!-- Updated mesh names: replaced underscores with hyphens and added dimensions="2". -->
  <mesh name="NASTIN-Mesh1" dimensions="2">
    <use-data name="Displacements1"/>
    <use-data name="Forces1"/>
  </mesh>

  <mesh name="SOLIDZ1-Mesh" dimensions="2">
    <use-data name="Displacements1"/>
    <use-data name="Forces1"/>
  </mesh>

  <mesh name="NASTIN-Mesh2" dimensions="2">
    <use-data name="Displacements2"/>
    <use-data name="Forces2"/>
  </mesh>

  <mesh name="SOLIDZ2-Mesh" dimensions="2">
    <use-data name="Displacements2"/>
    <use-data name="Forces2"/>
  </mesh>

  <mesh name="NASTIN-Mesh3" dimensions="2">
    <use-data name="Displacements3"/>
    <use-data name="Forces3"/>
  </mesh>

  <mesh name="SOLIDZ3-Mesh" dimensions="2">
    <use-data name="Displacements3"/>
    <use-data name="Forces3"/>
  </mesh>

  <mesh name="NASTIN-Mesh4" dimensions="2">
    <use-data name="Displacements4"/>
    <use-data name="Forces4"/>
  </mesh>

  <mesh name="SOLIDZ4-Mesh" dimensions="2">
    <use-data name="Displacements4"/>
    <use-data name="Forces4"/>
  </mesh>

  <!-- Participant NASTIN modifications -->
  <participant name="NASTIN">
    <!-- Replaced use-mesh provide="yes" with provide-mesh, and use-mesh from="..." with receive-mesh. -->
    <provide-mesh name="NASTIN-Mesh1"/>
    <provide-mesh name="NASTIN-Mesh2"/>
    <provide-mesh name="NASTIN-Mesh3"/>
    <provide-mesh name="NASTIN-Mesh4"/>
    <receive-mesh name="SOLIDZ1-Mesh" from="SOLIDZ1"/>
    <receive-mesh name="SOLIDZ2-Mesh" from="SOLIDZ2"/>
    <receive-mesh name="SOLIDZ3-Mesh" from="SOLIDZ3"/>
    <receive-mesh name="SOLIDZ4-Mesh" from="SOLIDZ4"/>

    <write-data name="Forces1" mesh="NASTIN-Mesh1"/>
    <write-data name="Forces2" mesh="NASTIN-Mesh2"/>
    <write-data name="Forces3" mesh="NASTIN-Mesh3"/>
    <write-data name="Forces4" mesh="NASTIN-Mesh4"/>
    <read-data  name="Displacements1" mesh="NASTIN-Mesh1"/>
    <read-data  name="Displacements2" mesh="NASTIN-Mesh2"/>
    <read-data  name="Displacements3" mesh="NASTIN-Mesh3"/>
    <read-data  name="Displacements4" mesh="NASTIN-Mesh4"/>

    <!-- Removed timing attributes from mapping tags and updated mesh names. -->
    <mapping:nearest-neighbor
      direction="write" from="NASTIN-Mesh1" to="SOLIDZ1-Mesh"
      constraint="conservative"/>
    <mapping:nearest-neighbor
      direction="write" from="NASTIN-Mesh2" to="SOLIDZ2-Mesh"
      constraint="conservative"/>
    <mapping:nearest-neighbor
      direction="write" from="NASTIN-Mesh3" to="SOLIDZ3-Mesh"
      constraint="conservative"/>
    <mapping:nearest-neighbor
      direction="write" from="NASTIN-Mesh4" to="SOLIDZ4-Mesh"
      constraint="conservative"/>
    <mapping:nearest-neighbor
      direction="read"  from="SOLIDZ1-Mesh" to="NASTIN-Mesh1"
      constraint="consistent"/>
    <mapping:nearest-neighbor
      direction="read"  from="SOLIDZ2-Mesh" to="NASTIN-Mesh2"
      constraint="consistent"/>
    <mapping:nearest-neighbor
      direction="read"  from="SOLIDZ3-Mesh" to="NASTIN-Mesh3"
      constraint="consistent"/>
    <mapping:nearest-neighbor
      direction="read"  from="SOLIDZ4-Mesh" to="NASTIN-Mesh4"
      constraint="consistent"/>
  </participant>

  <!-- Participant SOLIDZ1 -->
  <participant name="SOLIDZ1">
    <provide-mesh name="SOLIDZ1-Mesh"/>
    <write-data name="Displacements1" mesh="SOLIDZ1-Mesh"/>
    <read-data  name="Forces1"      mesh="SOLIDZ1-Mesh"/>
  </participant>

  <!-- Participant SOLIDZ2 -->
  <participant name="SOLIDZ2">
    <provide-mesh name="SOLIDZ2-Mesh"/>
    <write-data name="Displacements2" mesh="SOLIDZ2-Mesh"/>
    <read-data  name="Forces2"      mesh="SOLIDZ2-Mesh"/>
  </participant>

  <!-- Participant SOLIDZ3 -->
  <participant name="SOLIDZ3">
    <provide-mesh name="SOLIDZ3-Mesh"/>
    <write-data name="Displacements3" mesh="SOLIDZ3-Mesh"/>
    <read-data  name="Forces3"      mesh="SOLIDZ3-Mesh"/>
  </participant>

  <!-- Participant SOLIDZ4 -->
  <participant name="SOLIDZ4">
    <provide-mesh name="SOLIDZ4-Mesh"/>
    <write-data name="Displacements4" mesh="SOLIDZ4-Mesh"/>
    <read-data  name="Forces4"      mesh="SOLIDZ4-Mesh"/>
  </participant>

  <!-- Updated m2n:sockets to new attribute names and directory conventions -->
  <m2n:sockets acceptor="NASTIN" connector="SOLIDZ1" exchange-directory="../"/>
  <m2n:sockets acceptor="NASTIN" connector="SOLIDZ2" exchange-directory="../"/>
  <m2n:sockets acceptor="NASTIN" connector="SOLIDZ3" exchange-directory="../"/>
  <m2n:sockets acceptor="NASTIN" connector="SOLIDZ4" exchange-directory="../"/>

  <coupling-scheme:multi>
    <participant name="NASTIN" control="yes"/>
    <participant name="SOLIDZ1"/>
    <participant name="SOLIDZ2"/>
    <participant name="SOLIDZ3"/>
    <participant name="SOLIDZ4"/>

    <!-- Renamed attributes in coupling-scheme -->
    <max-time-windows value="20"/>           <!-- Changed from max-timesteps -->
    <time-window-size value="1e-4"/>         <!-- Changed from timestep-length -->

    <!-- Updated exchanges with new mesh names -->
    <exchange data="Forces1" mesh="SOLIDZ1-Mesh" from="NASTIN" to="SOLIDZ1"/>
    <exchange data="Forces2" mesh="SOLIDZ2-Mesh" from="NASTIN" to="SOLIDZ2"/>
    <exchange data="Forces3" mesh="SOLIDZ3-Mesh" from="NASTIN" to="SOLIDZ3"/>
    <exchange data="Forces4" mesh="SOLIDZ4-Mesh" from="NASTIN" to="SOLIDZ4"/>
    <exchange data="Displacements1" mesh="SOLIDZ1-Mesh" from="SOLIDZ1" to="NASTIN"/>
    <exchange data="Displacements2" mesh="SOLIDZ2-Mesh" from="SOLIDZ2" to="NASTIN"/>
    <exchange data="Displacements3" mesh="SOLIDZ3-Mesh" from="SOLIDZ3" to="NASTIN"/>
    <exchange data="Displacements4" mesh="SOLIDZ4-Mesh" from="SOLIDZ4" to="NASTIN"/>

    <max-iterations value="30"/>

    <!-- Updated relative-convergence-measure elements -->
    <relative-convergence-measure data="Displacements1" mesh="SOLIDZ1-Mesh" limit="1e-4"/>
    <relative-convergence-measure data="Displacements2" mesh="SOLIDZ2-Mesh" limit="1e-4"/>
    <relative-convergence-measure data="Displacements3" mesh="SOLIDZ3-Mesh" limit="1e-4"/>
    <relative-convergence-measure data="Displacements4" mesh="SOLIDZ4-Mesh" limit="1e-4"/>
    <relative-convergence-measure data="Forces1"        mesh="SOLIDZ1-Mesh" limit="1e-4"/>
    <relative-convergence-measure data="Forces2"        mesh="SOLIDZ2-Mesh" limit="1e-4"/>
    <relative-convergence-measure data="Forces3"        mesh="SOLIDZ3-Mesh" limit="1e-4"/>
    <relative-convergence-measure data="Forces4"        mesh="SOLIDZ4-Mesh" limit="1e-4"/>

    <!-- Removed extrapolation-order element since it's not supported in v3. -->

    <!-- Renamed post-processing:IQN-ILS to acceleration:IQN-ILS and updated child element. -->
    <acceleration:IQN-ILS>
      <data name="Displacements1" mesh="SOLIDZ1-Mesh"/>
      <data name="Displacements2" mesh="SOLIDZ2-Mesh"/>
      <data name="Displacements3" mesh="SOLIDZ3-Mesh"/>
      <data name="Displacements4" mesh="SOLIDZ4-Mesh"/>
      <data name="Forces1" mesh="SOLIDZ1-Mesh"/>
      <data name="Forces2" mesh="SOLIDZ2-Mesh"/>
      <data name="Forces3" mesh="SOLIDZ3-Mesh"/>
      <data name="Forces4" mesh="SOLIDZ4-Mesh"/>
      <preconditioner type="residual-sum"/>
      <filter type="QR1" limit="1e-6"/>
      <initial-relaxation value="0.1"/>
      <max-used-iterations value="100"/>
      <!-- Changed timesteps-reused to time-windows-reused -->
      <time-windows-reused value="10"/>
    </acceleration:IQN-ILS>
  </coupling-scheme:multi>
</precice-configuration>
